<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>S.V. Ultimate Downloader</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #00f2ff; --bg: #050510; --glass: rgba(20, 20, 40, 0.8); --border: rgba(255, 255, 255, 0.1); }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; background-image: radial-gradient(circle at 10% 20%, rgba(0, 242, 255, 0.1) 0%, transparent 40%), radial-gradient(circle at 90% 80%, rgba(188, 19, 254, 0.1) 0%, transparent 40%); }
        
        /* CARD UI */
        .card { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--border); width: 90%; max-width: 420px; padding: 2rem; border-radius: 24px; text-align: center; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        h1 { font-weight: 900; font-size: 28px; margin: 0 0 5px 0; background: linear-gradient(to right, #fff, var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { color: #889; font-size: 11px; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 25px; }
        
        input { width: 100%; padding: 16px; background: rgba(0,0,0,0.4); border: 2px solid var(--border); border-radius: 16px; color: #fff; font-size: 16px; outline: none; box-sizing: border-box; margin-bottom: 20px; transition: 0.3s; }
        input:focus { border-color: var(--primary); background: rgba(0,0,0,0.6); }
        
        .btn-main { width: 100%; padding: 16px; border: none; border-radius: 16px; background: linear-gradient(135deg, var(--primary), #0066ff); color: #000; font-weight: 800; font-size: 16px; text-transform: uppercase; cursor: pointer; transition: 0.3s; }
        .btn-main:disabled { background: #333; color: #666; cursor: not-allowed; }
        .btn-main:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 0 20px rgba(0, 243, 255, 0.4); }

        .loader { display: none; width: 24px; height: 24px; border: 3px solid rgba(0,0,0,0.3); border-top: 3px solid #000; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #result { display: none; margin-top: 25px; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .thumb { width: 100%; height: 200px; border-radius: 16px; object-fit: cover; border: 1px solid var(--border); margin-bottom: 15px; }
        .dl-btn { display: flex; align-items: center; justify-content: center; width: 100%; padding: 14px; margin-bottom: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 12px; color: #fff; text-decoration: none; font-weight: 600; transition: 0.3s; box-sizing: border-box; }
        .dl-btn:hover { background: var(--primary); color: #000; border-color: var(--primary); }
        .status { margin-top: 15px; font-size: 12px; min-height: 20px; color: #ff4466; }

        /* CHAT */
        .chat-toggle { position: fixed; bottom: 20px; right: 20px; width: 55px; height: 55px; background: var(--primary); border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 0 20px rgba(0, 242, 255, 0.4); color: #000; font-size: 24px; z-index: 100; }
        .chat-box { position: fixed; bottom: 85px; right: 20px; width: 300px; height: 400px; background: #0a0a12; border: 1px solid var(--primary); border-radius: 20px; display: none; flex-direction: column; overflow: hidden; z-index: 100; }
        .chat-content { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 8px 12px; border-radius: 10px; max-width: 80%; font-size: 13px; }
        .msg-user { background: #222; align-self: flex-end; color: white; }
        .msg-ai { background: rgba(0, 242, 255, 0.15); align-self: flex-start; color: var(--primary); }
        .chat-input-area { display: flex; border-top: 1px solid #333; padding: 10px; }
        .chat-input { flex: 1; background: transparent; border: none; color: white; outline: none; }
        .chat-send { color: var(--primary); cursor: pointer; font-size: 18px; margin-left: 10px; }
    </style>
</head>
<body>

    <div class="card">
        <h1>S.V. DOWNLOADER</h1>
        <div class="subtitle">Premium Media Saver</div>
        <input type="text" id="urlInput" placeholder="Paste link (Insta, YT, TikTok)..." autocomplete="off">
        <button class="btn-main" id="mainBtn" onclick="startSwarm()">
            <span id="btnText">DOWNLOAD NOW</span>
            <div class="loader" id="loader"></div>
        </button>
        <div id="status" class="status"></div>
        <div id="result">
            <img id="thumb" class="thumb" src="">
            <div id="links"></div>
        </div>
    </div>

    <div class="chat-toggle" onclick="toggleChat()"><i class="fas fa-comment-dots"></i></div>
    <div class="chat-box" id="chatBox">
        <div class="chat-content" id="chatContent"><div class="msg msg-ai">Hi! I am S.V. Support. Need help?</div></div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type here..." onkeypress="if(event.key==='Enter') sendMessage()">
            <i class="fas fa-paper-plane chat-send" onclick="sendMessage()"></i>
        </div>
    </div>

    <script>
        // --- 1. THE POWERFUL API LIST ---
        // These are the best community instances available right now.
        const APIS = [
            "https://cobalt.steamship.site/api/json",
            "https://cobalt-api.ayo.tf/api/json",
            "https://co.wuk.sh/api/json",
            "https://cobalt.q13.fr/api/json",
            "https://cobalt.rudart.cc/api/json",
            "https://api.cobalt.tools/api/json",
            "https://cobalt.kwiatekmiki.pl/api/json"
        ];

        // --- 2. THE PROXY TUNNELS ---
        // If direct connection fails, we tunnel through these.
        const TUNNELS = [
            (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
            (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
            (url) => `https://thingproxy.freeboard.io/fetch/${url}`
        ];

        async function startSwarm() {
            const url = document.getElementById('urlInput').value.trim();
            const btn = document.getElementById('mainBtn');
            const loader = document.getElementById('loader');
            const status = document.getElementById('status');
            const result = document.getElementById('result');

            if (!url) { status.innerText = "Please paste a link first."; return; }

            // UI RESET
            status.innerText = ""; result.style.display = "none";
            document.getElementById('btnText').style.display = "none";
            loader.style.display = "block"; btn.disabled = true;

            // SPECIAL: TERABOX HANDLING
            if (url.includes('terabox') || url.includes('1024tera')) {
                setTimeout(() => {
                    window.location.href = `https://teraboxdownloader.com/?url=${encodeURIComponent(url)}`;
                    resetBtn();
                }, 1500);
                return;
            }

            // START THE SWARM
            let success = false;

            // Loop 1: Try every API
            for (let api of APIS) {
                if (success) break;

                // Loop 2: Try every Tunnel for that API
                for (let tunnel of TUNNELS) {
                    try {
                        console.log(`Trying ${api}...`);
                        
                        // We use a simplified payload to avoid 400 Errors
                        const targetUrl = tunnel(api);
                        
                        const response = await fetch(targetUrl, {
                            method: 'POST',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json',
                                'Origin': 'https://cobalt.tools' // Header Spoofing
                            },
                            body: JSON.stringify({ url: url })
                        });

                        const data = await response.json();
                        
                        // Check if valid
                        if (data.status === 'error' || data.text) continue;

                        if (data.url || data.picker) {
                            showSuccess(data);
                            success = true;
                            break;
                        }
                    } catch (e) {
                        continue;
                    }
                }
            }

            if (!success) {
                status.innerText = "All servers are currently busy. Please wait 30 seconds.";
                resetBtn();
            }
        }

        function showSuccess(data) {
            const result = document.getElementById('result');
            const thumb = document.getElementById('thumb');
            const links = document.getElementById('links');

            // Thumbnail
            let tUrl = "https://via.placeholder.com/400x200/000000/00f2ff?text=Media+Found";
            if (data.picker && data.picker[0].thumb) tUrl = data.picker[0].thumb;
            else if (data.thumb) tUrl = data.thumb;
            thumb.src = tUrl;

            // Buttons
            links.innerHTML = "";
            if (data.picker) {
                data.picker.forEach(item => createBtn(item.url, item.type, links));
            } else if (data.url) {
                createBtn(data.url, 'video', links);
            }

            result.style.display = "block";
            resetBtn();
        }

        function createBtn(url, type, container) {
            const btn = document.createElement('a');
            btn.href = url;
            btn.className = 'dl-btn';
            btn.target = '_blank';
            btn.innerHTML = `<i class="fas fa-download"></i> Download ${type === 'video' ? 'Video' : 'Audio'}`;
            container.appendChild(btn);
        }

        function resetBtn() {
            const btn = document.getElementById('mainBtn');
            const loader = document.getElementById('loader');
            btn.disabled = false; loader.style.display = "none";
            document.getElementById('btnText').style.display = "block";
        }

        // CHAT FUNCTIONS
        function toggleChat() {
            const box = document.getElementById('chatBox');
            box.style.display = box.style.display === 'flex' ? 'none' : 'flex';
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            const content = document.getElementById('chatContent');
            if (!msg) return;

            content.innerHTML += `<div class="msg msg-user">${msg}</div>`;
            input.value = ""; content.scrollTop = content.scrollHeight;

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg })
                });
                const res = await response.json();
                content.innerHTML += `<div class="msg msg-ai">${res.text}</div>`;
            } catch (e) {
                content.innerHTML += `<div class="msg msg-ai" style="color:red">Error connecting.</div>`;
            }
            content.scrollTop = content.scrollHeight;
        }
    </script>
</body>
</html>
